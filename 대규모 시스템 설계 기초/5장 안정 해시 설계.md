# 5장. 안정 해시 설계

# 해시 키 재배치(rehash) 문제

해시함수를 이용해 N캐의 캐시 서버에 부하를 균등하게 나누기

serverIndex = hash(key) % N(N은 서버 개수)

| 키 | 해시 | 해시 % 4(서버 인덱스) |
| --- | --- | --- |
| key0 | 18358617 | 1 |
| key1 | 26143584 | 0 |
| key2 | 18131146 | 2 |
| key3 | 35863496 | 0 |
| key4 | 34085809 | 1 |
| key5 | 27581703 | 3 |
| key6 | 38164978 | 2 |
| key7 | 22530351 | 3 |

특정한 키가 보관된 서버를 알아내기 위해, 나머지(modular) 연산을 f(key) % 4와 같이 적용했다.

hash(key0) % 4 = 1이면, 클라이언트는 캐시에 보관된 데이터를 가져오기 위해 서버 1에 접속해야 한다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%20b4be8/Untitled.png)

이 방법은 서버 풀(server pool)의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다.

→ 서버가 추가 또는 삭제되면 문제 발생

서버 1번이 죽으면 n은 3이 되고 서버 인덱스가 바뀌면서 1번 서버의 키 뿐만 아니라 모든 키가 재분배된다.

→ 대규모 캐시미스(cache miss) 발생

# 안정 해시

해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치 (k: 키의 개수, n: 슬롯(slot)의 개수)

## 해시 공간과 해시 링

설명을 위한 사전 설정

- SHA-1 사용
- 함수 출력 값 범위는 x0, x1, x2, x3, ...xn
→ SHA-1 해시 공간(hash space) 범위는 0부터 2^160 -1

![해시 공간](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%20b4be8/Untitled%201.png)

해시 공간

![캐시 링](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%20b4be8/Untitled%202.png)

캐시 링

## 해시 서버

해시 함수 f를 사용하면 서버 IP나 이름을 이 링 위의 어떤 위치에 대응시킬 수 있다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%20b4be8/Untitled%203.png)

## 해시 키

캐시할 키 또한 해시 링 위의 어느 지점에 배치할 수 있다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%20b4be8/Untitled%204.png)

## 서버 조회