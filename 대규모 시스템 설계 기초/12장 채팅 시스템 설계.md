# 12장. 채팅 시스템 설계

# 1단계 문제 이해 및 설계 범위 확정

- 응답지연이 낮은 일대일 채팅 기능
- 최대 100명까지 참여할 수 있는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러단말에 동시 접속 지원
- 푸시 알림
- 모바일, 앱 단말 지원

# 2단계 개략적 설계안 제시 및 동의 구하기

채팅 시스템은 모바일 앱이거나 웹 애플리케이션이다.

클라이언트는 서로 직접 통신하지 않고, 채팅 서비스와 통신한다.

**채팅 서비스 기능**

- 클라이언트로부터 메시지 수신
- 메시지 수신자(recipient) 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관

어떤 통신 프로토콜을 사용할지 골라야한다.

**송신 시나리오**

메시지 송신 클라이언트(sender): 이번 단계에서는 수신 클라이언트에게 전달할 메시지를 채팅 서비스에 보낼 때, HTTP 프로토콜 사용한다.

HTTP를 사용하게 되면, 클라이언트는 채팅 서비스에 HTTP 프로토콜로 연결한 다음 메시지를 보내어 수신자에게 해당 메시지를 전달하라고 알린다. 채팅 서비스와의 접속에는 keep-alive 헤더를 사용하면 효율적인데, 클라이언트와 서버 사이의 연결을 끊지 않고 계속 유지할 수 있다.

TCP 접속 과정에서 발생하는 핸드셰이크(hand-shake) 횟수를 줄일수도 있다.

**수신 시나리오**

송신 시나리오보다 복잡하다. HTTP는 클라이언트가 연결을 만드는 프로토콜이며, 서버에서 클라이언트로 임의 시점에 메시지를 보내는 데는 쉽게 쓰일 수 없다. 서버가 연결을 만드는 것처럼 동작할 수 있도록 하기 위해 폴링(Polling), 롱 폴링(Long Polling), 웹소켓(WebSocket) 등의 기술이 쓰인다.

## 폴링

서버에게 새 메시지가 있느냐고 물어보는 방법이다.

답해줄 메시지가 없는 경우에 서버 자원이 불필요하게 낭비된다.

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%2069d232f49acd43478be92524a5f90914/Untitled.png)

## 롱 폴링

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%2069d232f49acd43478be92524a5f90914/Untitled%201.png)

## 롱 폴링

새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지한다.

새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작한다.

**약점**

- Round robin 알고리즘을 사용하는 경우, sender와  receiver가 같은 채팅 서버에 접속하게 되지 않을 수 있다.
- 서버 입장에서는 클라이언트가 연결을 해제했는지 아닌지 알 좋은 방법이 없다.
- 타임아웃이 일어날 때마다 주기적으로 서버에 다시 접속하기에 여전히 비효율적이다.

## 웹소켓

서버가 클라이언트에게 비동기(async) 메시지를 보낼 때 가장 널리 사용하는 기술이다.

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%2069d232f49acd43478be92524a5f90914/Untitled%202.png)

웹소켓 연결은 클라이언트가 시작한다. 한번 맺어진 연결은 항구적이며 양방향이다.

처음에는 HTTP 연결이지만 특정 핸드셰이크 절차를 거쳐 웹소켓 연결로 업그레이드된다. 연결된 이후에 서버는 클라이언트에게 비동기적으로 메시지를 전송할 수 있다.

웹소켓은 HTTP와 HTTPS처럼 80이나 443과 같은 기본 포트를 사용하기에 방화벽 환경에서도 잘 작동한다.

### 개략적 설계안

채팅 시스템은 대부분 세 부분으로 나누어 볼 수 있다.

Stateless 서비스, Stateful 서비스, 제 3자 서비스 연동

**무상태Stateless 서비스**

서버에 세션Session 상태가 없는 것이다.

각각의 요청을 독립적인 트랜잭션으로 취급하는 통신 프로토콜로, 통신이 독립적인 쌍의 요청과 응답을 이룰 수 있게 하는 방식이다. 무상태 프로토콜은 서버가 복수의 요청 시간대에 각각의 통신 파트너에 대한 세션 정보나 상태 보관을 요구하지 않는다.

**상태유지Stateful 서비스**

**제 3자 서비스 연동**